---
# Web Server role tasks
# Purpose: Configure Nginx/Apache web servers

- name: Install Nginx
  apt:
    name: nginx
    state: present
  when: app_webserver | default('nginx') == 'nginx'
  tags:
    - web_server
    - nginx

- name: Create Nginx configuration
  copy:
    content: |
      user www-data;
      worker_processes auto;
      pid /run/nginx.pid;

      events {
        worker_connections 768;
        multi_accept on;
      }

      http {
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        client_max_body_size 20M;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        gzip on;
        gzip_vary on;
        gzip_min_length 1000;
        gzip_types text/plain text/css text/xml text/javascript
                   application/x-javascript application/xml+rss;

        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
      }
    dest: /etc/nginx/nginx.conf
    backup: yes
  when: app_webserver | default('nginx') == 'nginx'
  notify: Reload Nginx
  tags:
    - web_server
    - nginx

- name: Create application site configuration
  copy:
    content: |
      upstream application {
        server localhost:{{ app_port | default('8080') }};
      }

      server {
        listen 80;
        server_name _;

        access_log /var/log/nginx/{{ app_name | default('app') }}.access.log;
        error_log /var/log/nginx/{{ app_name | default('app') }}.error.log;

        location / {
          proxy_pass http://application;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_redirect off;
        }

        location /health {
          access_log off;
          return 200 "healthy\n";
          add_header Content-Type text/plain;
        }
      }
    dest: "/etc/nginx/sites-available/{{ app_name | default('app') }}"
    backup: yes
  when: app_webserver | default('nginx') == 'nginx'
  notify: Reload Nginx
  tags:
    - web_server
    - nginx

- name: Enable application site
  file:
    src: "/etc/nginx/sites-available/{{ app_name | default('app') }}"
    dest: "/etc/nginx/sites-enabled/{{ app_name | default('app') }}"
    state: link
  when: app_webserver | default('nginx') == 'nginx'
  notify: Reload Nginx
  tags:
    - web_server
    - nginx

- name: Disable default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  when: app_webserver | default('nginx') == 'nginx'
  notify: Reload Nginx
  tags:
    - web_server
    - nginx

- name: Test Nginx configuration
  command: nginx -t
  when: app_webserver | default('nginx') == 'nginx'
  tags:
    - web_server
    - nginx

- name: Enable and start Nginx
  systemd:
    name: nginx
    state: started
    enabled: yes
  when: app_webserver | default('nginx') == 'nginx'
  tags:
    - web_server
    - nginx

- name: Configure firewall for web server
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "80"
    - "443"
  when: enable_firewall | default(true)
  tags:
    - web_server
    - firewall

- name: Create application directory
  file:
    path: "/opt/applications/{{ app_name | default('app') }}"
    state: directory
    owner: "{{ deployment_user | default('www-data') }}"
    group: "{{ deployment_group | default('www-data') }}"
    mode: '0755'
  tags:
    - web_server
    - application

- name: Setup application log directory
  file:
    path: "/opt/applications/{{ app_name | default('app') }}/shared/logs"
    state: directory
    owner: "{{ deployment_user | default('www-data') }}"
    group: "{{ deployment_group | default('www-data') }}"
    mode: '0755'
  tags:
    - web_server
    - application

- name: Configure logrotate for application
  copy:
    content: |
      /opt/applications/{{ app_name | default('app') }}/shared/logs/*.log
      {
          daily
          rotate 7
          compress
          delaycompress
          notifempty
          create 0640 {{ deployment_user | default('www-data') }} {{ deployment_group | default('www-data') }}
          sharedscripts
      }
    dest: "/etc/logrotate.d/{{ app_name | default('app') }}"
  tags:
    - web_server
    - logging
