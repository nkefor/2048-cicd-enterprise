---
# Playbook: Monitoring Stack Setup
# Purpose: Deploy monitoring infrastructure (Prometheus, Grafana, node exporter)
# Author: DevOps Team
# Version: 1.0.0
# Last Updated: 2025-11-19

- name: Setup Monitoring and Observability Stack
  hosts: all
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Validate monitoring parameters
      assert:
        that:
          - monitoring_environment is defined
        fail_msg: "Missing required monitoring parameters"
      tags: always

    - name: Create monitoring directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/monitoring
        - /opt/monitoring/prometheus
        - /opt/monitoring/grafana
        - /opt/monitoring/alertmanager
        - /var/log/monitoring
      tags: always

  roles:
    - name: common
      tags: common

  tasks:
    # Node Exporter Installation (Prometheus metrics)
    - name: Install and configure Node Exporter
      block:
        - name: Download Node Exporter
          get_url:
            url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
            dest: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
            checksum: "sha256:{{ node_exporter_checksum }}"
            timeout: 60
          tags: node_exporter

        - name: Extract Node Exporter
          unarchive:
            src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
            dest: /tmp
            remote_src: yes
          tags: node_exporter

        - name: Install Node Exporter binary
          copy:
            src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
            dest: /usr/local/bin/node_exporter
            owner: root
            group: root
            mode: '0755'
            remote_src: yes
          tags: node_exporter

        - name: Create Node Exporter systemd service
          copy:
            content: |
              [Unit]
              Description=Prometheus Node Exporter
              After=network-online.target
              Wants=network-online.target

              [Service]
              Type=simple
              User=node_exporter
              Group=node_exporter
              ExecStart=/usr/local/bin/node_exporter \
                --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/) \
                --collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs) \
                --collector.netclass.ignored-devices=^(veth.*)$$

              SyslogIdentifier=node_exporter
              Restart=always
              RestartSec=5

              [Install]
              WantedBy=multi-user.target
            dest: /etc/systemd/system/node_exporter.service
            owner: root
            group: root
            mode: '0644'
          notify: Restart Node Exporter
          tags: node_exporter

        - name: Create node_exporter user
          user:
            name: node_exporter
            shell: /bin/false
            system: yes
            create_home: no
          tags: node_exporter

        - name: Enable and start Node Exporter
          systemd:
            name: node_exporter
            state: started
            enabled: yes
            daemon_reload: yes
          tags: node_exporter

      tags: monitoring

    # Prometheus Installation
    - name: Install and configure Prometheus
      block:
        - name: Download Prometheus
          get_url:
            url: "https://github.com/prometheus/prometheus/releases/download/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
            dest: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
            timeout: 60
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          tags: prometheus

        - name: Extract Prometheus
          unarchive:
            src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
            dest: /tmp
            remote_src: yes
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          tags: prometheus

        - name: Create Prometheus directories
          file:
            path: "{{ item }}"
            state: directory
            owner: prometheus
            group: prometheus
            mode: '0755'
          loop:
            - /etc/prometheus
            - /var/lib/prometheus
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          tags: prometheus

        - name: Copy Prometheus binary
          copy:
            src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64/prometheus"
            dest: /usr/local/bin/prometheus
            owner: root
            group: root
            mode: '0755'
            remote_src: yes
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          tags: prometheus

        - name: Create Prometheus configuration
          copy:
            content: |
              global:
                scrape_interval: 15s
                evaluation_interval: 15s
                external_labels:
                  environment: {{ monitoring_environment }}
                  cluster: {{ cluster_name | default('default') }}

              alerting:
                alertmanagers:
                  - static_configs:
                      - targets:
                          - localhost:9093

              rule_files:
                - "/etc/prometheus/rules.yml"

              scrape_configs:
                - job_name: 'prometheus'
                  static_configs:
                    - targets: ['localhost:9090']

                - job_name: 'node'
                  static_configs:
                    - targets: ['localhost:9100']

                {% if groups['webservers'] is defined %}
                - job_name: 'webservers'
                  static_configs:
                    - targets:
                {% for host in groups['webservers'] %}
                        - '{{ hostvars[host].ansible_host }}:9100'
                {% endfor %}
                {% endif %}

                {% if groups['databases'] is defined %}
                - job_name: 'databases'
                  static_configs:
                    - targets:
                {% for host in groups['databases'] %}
                        - '{{ hostvars[host].ansible_host }}:9100'
                {% endfor %}
                {% endif %}
            dest: /etc/prometheus/prometheus.yml
            owner: prometheus
            group: prometheus
            mode: '0644'
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          notify: Reload Prometheus
          tags: prometheus

        - name: Create Prometheus alerting rules
          copy:
            content: |
              groups:
                - name: host_alerts
                  interval: 30s
                  rules:
                    - alert: HighCPUUsage
                      expr: (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
                      for: 5m
                      labels:
                        severity: warning
                      annotations:
                        summary: "High CPU usage on {{ '{{ $labels.instance }}' }}"
                        description: "CPU usage is {{ '{{ $value }}' }}%"

                    - alert: HighMemoryUsage
                      expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
                      for: 5m
                      labels:
                        severity: warning
                      annotations:
                        summary: "High memory usage on {{ '{{ $labels.instance }}' }}"

                    - alert: HighDiskUsage
                      expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lowerfs"} / node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lowerfs"})) * 100 > 85
                      for: 5m
                      labels:
                        severity: warning
                      annotations:
                        summary: "High disk usage on {{ '{{ $labels.instance }}' }}"

                    - alert: ServiceDown
                      expr: up == 0
                      for: 1m
                      labels:
                        severity: critical
                      annotations:
                        summary: "Service {{ '{{ $labels.job }}' }} is down on {{ '{{ $labels.instance }}' }}"

                    - alert: NodeNotReady
                      expr: node_boot_time_seconds == 0
                      for: 5m
                      labels:
                        severity: critical
                      annotations:
                        summary: "Node {{ '{{ $labels.instance }}' }} is not responding"
            dest: /etc/prometheus/rules.yml
            owner: prometheus
            group: prometheus
            mode: '0644'
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          notify: Reload Prometheus
          tags: prometheus

        - name: Create Prometheus systemd service
          copy:
            content: |
              [Unit]
              Description=Prometheus
              Wants=network-online.target
              After=network-online.target

              [Service]
              Type=simple
              User=prometheus
              Group=prometheus
              ExecStart=/usr/local/bin/prometheus \
                --config.file=/etc/prometheus/prometheus.yml \
                --storage.tsdb.path=/var/lib/prometheus/ \
                --storage.tsdb.retention.time={{ prometheus_retention | default('15d') }}

              SyslogIdentifier=prometheus
              Restart=always
              RestartSec=5

              [Install]
              WantedBy=multi-user.target
            dest: /etc/systemd/system/prometheus.service
            owner: root
            group: root
            mode: '0644'
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          notify: Restart Prometheus
          tags: prometheus

        - name: Create prometheus user
          user:
            name: prometheus
            shell: /bin/false
            system: yes
            create_home: no
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          tags: prometheus

      tags: monitoring

    # Grafana Installation
    - name: Install and configure Grafana
      block:
        - name: Add Grafana repository
          apt_repository:
            repo: "deb https://packages.grafana.com/oss/deb stable main"
            state: present
            filename: grafana
          when: ansible_os_family == "Debian" and ('grafana' in group_names or 'monitoring' in group_names)
          tags: grafana

        - name: Install Grafana
          apt:
            name: grafana-server
            state: present
            update_cache: yes
          when: ansible_os_family == "Debian" and ('grafana' in group_names or 'monitoring' in group_names)
          tags: grafana

        - name: Configure Grafana
          copy:
            content: |
              [server]
              http_port = 3000
              domain = {{ grafana_domain | default('localhost') }}
              root_url = http://{{ grafana_domain | default('localhost') }}/grafana

              [auth]
              disable_login_form = false
              oauth_auto_login = false

              [security]
              admin_user = {{ grafana_admin_user | default('admin') }}
              admin_password = {{ grafana_admin_password | default('admin') }}
              secret_key = {{ grafana_secret_key | default('generated_secret') }}

              [analytics]
              reporting_enabled = true
            dest: /etc/grafana/provisioning/grafana.ini
            backup: yes
          when: ('grafana' in group_names or 'monitoring' in group_names)
          notify: Restart Grafana
          tags: grafana

        - name: Create Grafana data sources
          copy:
            content: |
              apiVersion: 1

              datasources:
                - name: Prometheus
                  type: prometheus
                  access: proxy
                  url: http://localhost:9090
                  isDefault: true
                  editable: true
            dest: /etc/grafana/provisioning/datasources/prometheus.yml
            owner: grafana
            group: grafana
            mode: '0644'
          when: ('grafana' in group_names or 'monitoring' in group_names)
          tags: grafana

        - name: Enable and start Grafana
          systemd:
            name: grafana-server
            state: started
            enabled: yes
          when: ('grafana' in group_names or 'monitoring' in group_names)
          tags: grafana

      tags: monitoring

    # AlertManager Installation
    - name: Install and configure AlertManager
      block:
        - name: Download AlertManager
          get_url:
            url: "https://github.com/prometheus/alertmanager/releases/download/v{{ alertmanager_version }}/alertmanager-{{ alertmanager_version }}.linux-amd64.tar.gz"
            dest: "/tmp/alertmanager-{{ alertmanager_version }}.linux-amd64.tar.gz"
            timeout: 60
          when: "'alertmanager' in group_names or 'monitoring' in group_names"
          tags: alertmanager

        - name: Extract AlertManager
          unarchive:
            src: "/tmp/alertmanager-{{ alertmanager_version }}.linux-amd64.tar.gz"
            dest: /tmp
            remote_src: yes
          when: "'alertmanager' in group_names or 'monitoring' in group_names"
          tags: alertmanager

        - name: Install AlertManager binary
          copy:
            src: "/tmp/alertmanager-{{ alertmanager_version }}.linux-amd64/alertmanager"
            dest: /usr/local/bin/alertmanager
            owner: root
            group: root
            mode: '0755'
            remote_src: yes
          when: "'alertmanager' in group_names or 'monitoring' in group_names"
          tags: alertmanager

        - name: Create AlertManager configuration
          copy:
            content: |
              global:
                resolve_timeout: 5m

              route:
                receiver: default
                group_by:
                  - alertname
                  - cluster
                  - service
                group_wait: 30s
                group_interval: 5m
                repeat_interval: 4h

                routes:
                  - match:
                      severity: critical
                    receiver: critical_alerts
                    continue: true

              receivers:
                - name: default
                  webhook_configs:
                    - url: http://localhost:5001/alert

                - name: critical_alerts
                  email_configs:
                    - to: {{ alert_email | default('admin@example.com') }}
                      from: {{ alert_from_email | default('alerts@example.com') }}
                      smarthost: {{ smtp_server | default('localhost:25') }}
            dest: /etc/prometheus/alertmanager.yml
            owner: alertmanager
            group: alertmanager
            mode: '0644'
          when: "'alertmanager' in group_names or 'monitoring' in group_names"
          tags: alertmanager

        - name: Create AlertManager systemd service
          copy:
            content: |
              [Unit]
              Description=Prometheus AlertManager
              Wants=network-online.target
              After=network-online.target

              [Service]
              Type=simple
              User=alertmanager
              Group=alertmanager
              ExecStart=/usr/local/bin/alertmanager \
                --config.file=/etc/prometheus/alertmanager.yml \
                --storage.path=/var/lib/alertmanager

              SyslogIdentifier=alertmanager
              Restart=always
              RestartSec=5

              [Install]
              WantedBy=multi-user.target
            dest: /etc/systemd/system/alertmanager.service
            owner: root
            group: root
            mode: '0644'
          when: "'alertmanager' in group_names or 'monitoring' in group_names"
          tags: alertmanager

        - name: Create alertmanager user
          user:
            name: alertmanager
            shell: /bin/false
            system: yes
            create_home: no
          when: "'alertmanager' in group_names or 'monitoring' in group_names"
          tags: alertmanager

      tags: monitoring

    # Monitoring Health Checks
    - name: Verify monitoring setup
      block:
        - name: Test Node Exporter connectivity
          uri:
            url: "http://{{ ansible_host }}:9100/metrics"
            method: GET
            status_code: 200
            timeout: 10
          register: node_exporter_check
          tags: verification

        - name: Test Prometheus connectivity
          uri:
            url: "http://{{ ansible_host }}:9090/-/healthy"
            method: GET
            status_code: 200
            timeout: 10
          when: "'prometheus' in group_names or 'monitoring' in group_names"
          ignore_errors: yes
          tags: verification

        - name: Test Grafana connectivity
          uri:
            url: "http://{{ ansible_host }}:3000/api/health"
            method: GET
            status_code: 200
            timeout: 10
          when: "'grafana' in group_names or 'monitoring' in group_names"
          ignore_errors: yes
          tags: verification

      tags: monitoring

  handlers:
    - name: Restart Node Exporter
      systemd:
        name: node_exporter
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Restart Prometheus
      systemd:
        name: prometheus
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Reload Prometheus
      systemd:
        name: prometheus
        state: reloaded

    - name: Restart Grafana
      systemd:
        name: grafana-server
        state: restarted
        enabled: yes

  post_tasks:
    - name: Generate monitoring setup report
      copy:
        content: |
          Monitoring Stack Setup Report
          =============================
          Timestamp: {{ ansible_date_time.iso8601 }}
          Hostname: {{ inventory_hostname }}

          Setup Status: COMPLETED

          Installed Components:
          - Node Exporter: http://{{ ansible_host }}:9100/metrics
          {% if 'prometheus' in group_names or 'monitoring' in group_names %}
          - Prometheus: http://{{ ansible_host }}:9090
          - Prometheus Rules: /etc/prometheus/rules.yml
          {% endif %}
          {% if 'grafana' in group_names or 'monitoring' in group_names %}
          - Grafana: http://{{ ansible_host }}:3000
          - Grafana Admin: {{ grafana_admin_user | default('admin') }}
          {% endif %}
          {% if 'alertmanager' in group_names or 'monitoring' in group_names %}
          - AlertManager: http://{{ ansible_host }}:9093
          {% endif %}

          Configuration Files:
          - /etc/prometheus/prometheus.yml
          - /etc/prometheus/rules.yml
          - /etc/prometheus/alertmanager.yml
          - /etc/grafana/provisioning/datasources/prometheus.yml

          Access Information:
          - Node Exporter API: http://{{ ansible_host }}:9100/metrics
          - Prometheus Web UI: http://{{ ansible_host }}:9090
          - Grafana Web UI: http://{{ ansible_host }}:3000

          Logs:
          - /var/log/prometheus
          - /var/log/grafana
          - /var/log/monitoring

          Next Steps:
          1. Access Grafana and configure dashboard
          2. Import pre-built dashboards
          3. Setup alert receivers
          4. Configure monitoring rules
          5. Test alert notifications
        dest: "/tmp/monitoring-setup-{{ inventory_hostname }}.report"
      tags: always

    - name: Display monitoring summary
      debug:
        msg: |
          Monitoring stack setup completed successfully!

          Services:
          - Node Exporter: http://{{ ansible_host }}:9100/metrics
          {% if 'prometheus' in group_names or 'monitoring' in group_names %}
          - Prometheus: http://{{ ansible_host }}:9090
          {% endif %}
          {% if 'grafana' in group_names or 'monitoring' in group_names %}
          - Grafana: http://{{ ansible_host }}:3000
          {% endif %}

          Configuration files:
          - Prometheus: /etc/prometheus/prometheus.yml
          - AlertManager: /etc/prometheus/alertmanager.yml
          - Grafana: /etc/grafana/grafana.ini

          Next: Import Grafana dashboards and configure alerts
      tags: always

  vars:
    node_exporter_version: "1.6.1"
    node_exporter_checksum: "sha256:5eaa1f1d87f0efdfe5d8c8c09f25597f1099cfcad9bfc6e75e5d5ca7f3fa7ce5"
    prometheus_version: "2.48.1"
    grafana_version: "10.2.0"
    alertmanager_version: "0.26.0"
    prometheus_retention: "15d"
    monitoring_environment: "production"
    cluster_name: "default"
    grafana_domain: "localhost"
    grafana_admin_user: "admin"
    grafana_admin_password: "admin"
    grafana_secret_key: "generated_secret_key"
    alert_email: "admin@example.com"
    alert_from_email: "alerts@example.com"
    smtp_server: "localhost:25"
