# Prometheus Configuration for Container Runtime Security

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'container-security-monitor'
    environment: 'production'
  query_log_file: /prometheus/query.log

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules
rule_files:
  - '/etc/prometheus/alerts.yml'

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 5s

  # Alertmanager
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
    scrape_interval: 15s

  # Node Exporter (Host metrics)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
      - source_labels: [__scheme__]
        target_label: scheme

  # cAdvisor (Container metrics)
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    scrape_interval: 30s
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance

  # Docker daemon (if enabled)
  - job_name: 'docker'
    static_configs:
      - targets: ['unix:///var/run/docker.sock']
    scrape_interval: 30s

  # Elasticsearch metrics (via elasticexporter if available)
  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['elasticsearch:9200']
    scrape_interval: 30s
    metrics_path: '/_prometheus/metrics'

  # Kibana metrics
  - job_name: 'kibana'
    static_configs:
      - targets: ['kibana:5601']
    scrape_interval: 30s
    metrics_path: '/api/status'

  # Falco metrics (via HTTP endpoint if exposed)
  - job_name: 'falco'
    static_configs:
      - targets: ['falco:5060']
    scrape_interval: 15s
    metrics_path: '/metrics'

  # Grafana metrics
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    scrape_interval: 30s
    metrics_path: '/metrics'
    basic_auth:
      username: admin
      password: admin

# Remote write configuration (optional, for long-term storage)
# remote_write:
#   - url: "http://remote-storage:9009/api/v1/push"
#     write_relabel_configs:
#       - source_labels: [__name__]
#         regex: 'falco_.*'
#         action: keep

# Remote read configuration (optional)
# remote_read:
#   - url: "http://remote-storage:9009/api/v1/read"
