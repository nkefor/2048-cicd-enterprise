name: Test Suite

on:
  pull_request:
    branches: [ main ]
    paths:
      - '2048/**'
      - 'tests/**'
      - 'package.json'
      - 'playwright.config.js'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  BASE_URL: http://localhost:8080

jobs:
  lint-and-security:
    name: Lint & Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: 2048/Dockerfile
          failure-threshold: error

      - name: Scan for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './2048'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  docker-tests:
    name: Docker Container Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run Docker build test
        run: bash tests/docker/test-build.sh

      - name: Run Docker health check test
        run: bash tests/docker/test-health.sh

      - name: Run security headers test
        run: bash tests/docker/test-security-headers.sh

      - name: Run all Docker tests
        run: bash tests/docker/run-all-tests.sh

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: docker-tests

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and run container
        run: |
          docker build -t 2048-e2e-test ./2048
          docker run -d -p 8080:80 --name e2e-test-container 2048-e2e-test
          sleep 5

      - name: Verify container is running
        run: |
          docker ps | grep e2e-test-container
          curl -f http://localhost:8080/ || exit 1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run E2E tests
        run: npx playwright test --project=${{ matrix.browser }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: test-results/
          retention-days: 7

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker rm -f e2e-test-container || true
          docker rmi 2048-e2e-test || true

  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    needs: docker-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and run container
        run: |
          docker build -t 2048-load-test ./2048
          docker run -d -p 8080:80 --name load-test-container 2048-load-test
          sleep 5

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 smoke test
        run: k6 run tests/load/k6-smoke-test.js

      - name: Run k6 load test
        run: k6 run tests/load/k6-load-test.js --duration 1m --vus 20

      - name: Upload k6 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: test-results/k6-summary.json
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker rm -f load-test-container || true
          docker rmi 2048-load-test || true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint-and-security, docker-tests, e2e-tests, load-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "╔════════════════════════════════════════════════════════╗"
          echo "║              Test Suite Summary                        ║"
          echo "╚════════════════════════════════════════════════════════╝"
          echo ""
          echo "All test jobs completed!"
          echo ""
          echo "Results:"
          echo "  - Lint & Security: ${{ needs.lint-and-security.result }}"
          echo "  - Docker Tests: ${{ needs.docker-tests.result }}"
          echo "  - E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "  - Load Tests: ${{ needs.load-tests.result }}"
          echo ""

      - name: Fail if any tests failed
        if: |
          needs.lint-and-security.result != 'success' ||
          needs.docker-tests.result != 'success' ||
          needs.e2e-tests.result != 'success' ||
          needs.load-tests.result != 'success'
        run: exit 1
