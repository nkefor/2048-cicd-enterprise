name: CI Pipeline - Quality Gate

on:
  pull_request:
    branches: [ main ]
    paths:
      - '2048/**'
      - 'tests/**'
      - 'scripts/**'
      - 'package.json'
      - 'playwright.config.js'
      - '.github/workflows/**'
      - 'sonar-project.properties'
  workflow_dispatch:

env:
  BASE_URL: http://localhost:8080
  DOCKER_IMAGE: 2048-ci-test

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================
  # STAGE 1: Lint & Validate
  # Fast checks that catch obvious issues before expensive jobs
  # ============================================================
  lint-validate:
    name: "Stage 1: Lint & Validate"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: 2048/Dockerfile
          failure-threshold: error

      - name: Validate YAML workflows
        run: |
          echo "Validating GitHub Actions workflow syntax..."
          for file in .github/workflows/*.yaml .github/workflows/*.yml; do
            if [ -f "$file" ]; then
              echo "  Checking: $file"
              python3 -c "import yaml; yaml.safe_load(open('$file'))" || {
                echo "FAIL: Invalid YAML in $file"
                exit 1
              }
              echo "  OK"
            fi
          done

      - name: Lint shell scripts
        run: |
          echo "Checking shell scripts..."
          SCRIPTS_FOUND=0
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              SCRIPTS_FOUND=1
              echo "  Checking: $script"
              bash -n "$script" || { echo "FAIL: Syntax error in $script"; exit 1; }
              echo "  OK: syntax valid"
            fi
          done
          if [ "$SCRIPTS_FOUND" -eq 0 ]; then
            echo "  No shell scripts found, skipping"
          fi

      - name: Validate NGINX config syntax
        run: |
          docker build -t nginx-validate ./2048
          docker run --rm nginx-validate nginx -t
          echo "NGINX config syntax is valid"

  # ============================================================
  # STAGE 2: Security Scanning
  # Parallel security checks for vulnerabilities and secrets
  # ============================================================
  security-scan:
    name: "Stage 2: Security Scan"
    runs-on: ubuntu-latest
    needs: lint-validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan filesystem for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './2048'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          format: 'table'

      - name: Scan for leaked secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Build image for scanning
        run: docker build -t ${{ env.DOCKER_IMAGE }}:scan ./2048

      - name: Scan Docker image for CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE }}:scan'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          format: 'table'

  # ============================================================
  # STAGE 2 (parallel): SonarQube Analysis
  # Code quality, bugs, vulnerabilities, and coverage
  # ============================================================
  sonarqube-analysis:
    name: "Stage 2: SonarQube Analysis"
    runs-on: ubuntu-latest
    needs: lint-validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true

      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      - name: Quality gate fallback (no SonarQube configured)
        run: |
          echo "============================================"
          echo "  SonarQube Quality Gate Status"
          echo "============================================"
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "SonarQube is not configured (SONAR_TOKEN not set)"
            echo "Falling back to local static analysis..."
            echo ""
            echo "Running basic code quality checks:"

            # Check for common anti-patterns in HTML/JS
            echo "  - Checking for inline event handlers..."
            if grep -r "onclick\|onload\|onerror" 2048/www/ 2>/dev/null; then
              echo "    WARNING: Found inline event handlers"
            else
              echo "    OK: No inline event handlers"
            fi

            echo "  - Checking for TODO/FIXME/HACK comments..."
            TODO_COUNT=$(grep -rc "TODO\|FIXME\|HACK\|XXX" 2048/www/ 2>/dev/null | awk -F: '{sum += $2} END {print sum}')
            echo "    Found ${TODO_COUNT:-0} TODO/FIXME/HACK comments"

            echo ""
            echo "Local quality checks passed (configure SonarQube for full analysis)"
          else
            echo "SonarQube analysis completed"
          fi

  # ============================================================
  # STAGE 2 (parallel): Container Tests
  # Build, health check, and security header validation
  # ============================================================
  container-tests:
    name: "Stage 2: Container Tests"
    runs-on: ubuntu-latest
    needs: lint-validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t ${{ env.DOCKER_IMAGE }} ./2048

      - name: Start container
        run: |
          docker run -d -p 8080:80 --name ci-test-container ${{ env.DOCKER_IMAGE }}
          sleep 3

      - name: Health check
        run: |
          echo "Testing HTTP 200 response..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FAIL: Expected HTTP 200, got $HTTP_CODE"
            exit 1
          fi
          echo "OK: HTTP $HTTP_CODE"

      - name: Verify security headers
        run: |
          echo "Verifying security headers..."
          HEADERS=$(curl -sI http://localhost:8080/)
          PASS=true

          check_header() {
            local header="$1"
            local expected="$2"
            if echo "$HEADERS" | grep -qi "$header"; then
              echo "  OK: $header present"
            else
              echo "  FAIL: $header missing"
              PASS=false
            fi
          }

          check_header "X-Content-Type-Options" "nosniff"
          check_header "X-Frame-Options" "DENY"
          check_header "X-XSS-Protection" "1"
          check_header "Referrer-Policy" "no-referrer"

          if [ "$PASS" = false ]; then
            echo "Security header check failed"
            exit 1
          fi
          echo "All security headers verified"

      - name: Docker health check status
        run: |
          echo "Waiting for Docker health check..."
          sleep 35
          HEALTH=$(docker inspect --format='{{.State.Health.Status}}' ci-test-container)
          echo "Health status: $HEALTH"
          if [ "$HEALTH" != "healthy" ]; then
            echo "FAIL: Container is not healthy"
            docker logs ci-test-container
            exit 1
          fi
          echo "OK: Container is healthy"

      - name: Response time check
        run: |
          echo "Checking response time..."
          TOTAL_TIME=$(curl -s -o /dev/null -w "%{time_total}" http://localhost:8080/)
          echo "Response time: ${TOTAL_TIME}s"
          # Fail if response takes more than 2 seconds
          if [ "$(echo "$TOTAL_TIME > 2.0" | bc -l)" -eq 1 ]; then
            echo "FAIL: Response time exceeds 2s threshold"
            exit 1
          fi
          echo "OK: Response time within threshold"

      - name: Cleanup
        if: always()
        run: |
          docker rm -f ci-test-container || true
          docker rmi ${{ env.DOCKER_IMAGE }} || true

  # ============================================================
  # QUALITY GATE DECISION
  # All Stage 2 jobs must pass before proceeding
  # ============================================================
  quality-gate:
    name: "Quality Gate Decision"
    runs-on: ubuntu-latest
    needs: [security-scan, sonarqube-analysis, container-tests]
    steps:
      - name: Quality gate summary
        run: |
          echo "╔═══════════════════════════════════════════════════╗"
          echo "║            QUALITY GATE RESULTS                   ║"
          echo "╠═══════════════════════════════════════════════════╣"
          echo "║                                                   ║"
          echo "║  Security Scan:      ${{ needs.security-scan.result }}  ║"
          echo "║  SonarQube Analysis: ${{ needs.sonarqube-analysis.result }}  ║"
          echo "║  Container Tests:    ${{ needs.container-tests.result }}  ║"
          echo "║                                                   ║"
          echo "╚═══════════════════════════════════════════════════╝"

      - name: Enforce gate
        if: |
          needs.security-scan.result != 'success' ||
          needs.container-tests.result != 'success'
        run: |
          echo "Quality gate FAILED - blocking merge"
          echo "Fix the failing checks above before merging"
          exit 1

      - name: Gate passed
        run: echo "Quality gate PASSED - safe to merge"
