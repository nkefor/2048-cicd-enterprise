apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-recording-rules
  namespace: observability
data:
  recording_rules.yml: |
    groups:
    - name: cpu_memory_rules
      interval: 30s
      rules:
      - record: job:node_cpu_utilization:avg
        expr: avg(rate(node_cpu_seconds_total[5m])) by (job)

      - record: job:node_memory_utilization:avg
        expr: avg(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) by (job)

      - record: namespace:pod_cpu_usage:sum
        expr: sum(rate(container_cpu_usage_seconds_total[5m])) by (namespace)

      - record: namespace:pod_memory_usage:sum
        expr: sum(container_memory_usage_bytes) by (namespace)

    - name: application_rules
      interval: 30s
      rules:
      - record: job:http_requests_total:rate5m
        expr: sum(rate(http_requests_total[5m])) by (job, status)

      - record: job:http_request_duration_seconds:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

      - record: job:http_request_duration_seconds:p99
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))
