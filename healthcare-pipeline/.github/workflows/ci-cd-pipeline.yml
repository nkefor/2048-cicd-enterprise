name: Healthcare Pipeline CI/CD

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.5.0
  PYTHON_VERSION: "3.11"

permissions:
  id-token: write
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ============================================================================
  # Security Scanning Jobs
  # ============================================================================

  secret-scanning:
    name: Secret Scanning (TruffleHog & Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-scanning:
    name: Dependency Scanning (Snyk)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r healthcare-pipeline/lambda-functions/pii-detection/requirements.txt
          pip install -r healthcare-pipeline/microservices/fhir-gateway/requirements.txt

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  iac-scanning:
    name: IaC Security Scanning (Checkov & tfsec)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov scan
        run: |
          checkov --directory healthcare-pipeline/terraform \
            --framework terraform \
            --output cli \
            --output junitxml \
            --output-file-path console,checkov-results.xml \
            --soft-fail

      - name: Upload Checkov results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-results
          path: checkov-results.xml

      - name: Run tfsec scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: healthcare-pipeline/terraform
          soft_fail: true

  container-scanning:
    name: Container Security Scanning (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build FHIR Gateway image
        run: |
          docker build -t fhir-gateway:${{ github.sha }} \
            healthcare-pipeline/microservices/fhir-gateway

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: fhir-gateway:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  sast-scanning:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================================================
  # Build and Test Jobs
  # ============================================================================

  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install black flake8 pylint mypy

      - name: Run Black (format check)
        run: |
          black --check healthcare-pipeline/lambda-functions
          black --check healthcare-pipeline/microservices

      - name: Run Flake8
        run: |
          flake8 healthcare-pipeline/lambda-functions --max-line-length=120
          flake8 healthcare-pipeline/microservices --max-line-length=120

      - name: Run Pylint
        run: |
          pylint healthcare-pipeline/lambda-functions/**/*.py || true
          pylint healthcare-pipeline/microservices/**/*.py || true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov boto3 moto fastapi

      - name: Run unit tests
        run: |
          pytest healthcare-pipeline/tests/ \
            --cov=healthcare-pipeline \
            --cov-report=xml \
            --cov-report=html

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive healthcare-pipeline/terraform

      - name: Terraform Init
        run: |
          cd healthcare-pipeline/terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd healthcare-pipeline/terraform
          terraform validate

      - name: TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        run: |
          cd healthcare-pipeline/terraform
          tflint --init
          tflint --recursive

  # ============================================================================
  # Build and Package Jobs
  # ============================================================================

  build-lambda:
    name: Build Lambda Functions
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-scanning, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build PII Detection Lambda
        run: |
          cd healthcare-pipeline/lambda-functions/pii-detection
          pip install -r requirements.txt -t package/
          cd package && zip -r ../pii-detection-${{ github.sha }}.zip .
          cd .. && zip -g pii-detection-${{ github.sha }}.zip lambda_function.py

      - name: Upload Lambda artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lambda-packages
          path: healthcare-pipeline/lambda-functions/*/*.zip

  build-containers:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: [container-scanning, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push FHIR Gateway
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: healthcare-fhir-gateway
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            healthcare-pipeline/microservices/fhir-gateway
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  # ============================================================================
  # Deployment Jobs
  # ============================================================================

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-lambda, build-containers, terraform-validate]
    if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/claude/')
    environment:
      name: development
      url: https://dev.healthcare-pipeline.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd healthcare-pipeline/terraform
          terraform init

      - name: Terraform Plan
        run: |
          cd healthcare-pipeline/terraform
          terraform plan -var-file=environments/dev/terraform.tfvars -out=tfplan

      - name: Terraform Apply
        run: |
          cd healthcare-pipeline/terraform
          terraform apply -auto-approve tfplan

      - name: Deploy Lambda Functions
        run: |
          aws lambda update-function-code \
            --function-name healthcare-pii-detection-dev \
            --zip-file fileb://healthcare-pipeline/lambda-functions/pii-detection/pii-detection-${{ github.sha }}.zip

      - name: Run Smoke Tests
        run: |
          python healthcare-pipeline/tests/smoke_tests.py --env=dev

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.healthcare-pipeline.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Apply
        run: |
          cd healthcare-pipeline/terraform
          terraform init
          terraform apply -var-file=environments/staging/terraform.tfvars -auto-approve

      - name: Integration Tests
        run: |
          python healthcare-pipeline/tests/integration_tests.py --env=staging

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://healthcare-pipeline.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Plan
        run: |
          cd healthcare-pipeline/terraform
          terraform init
          terraform plan -var-file=environments/prod/terraform.tfvars -out=tfplan

      - name: Manual Approval Required
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: devops-team
          minimum-approvals: 2

      - name: Terraform Apply
        run: |
          cd healthcare-pipeline/terraform
          terraform apply -auto-approve tfplan

      - name: Deploy Lambda Functions
        run: |
          aws lambda update-function-code \
            --function-name healthcare-pii-detection-prod \
            --zip-file fileb://healthcare-pipeline/lambda-functions/pii-detection/pii-detection-${{ github.sha }}.zip

      - name: Health Check
        run: |
          python healthcare-pipeline/tests/health_check.py --env=prod

      - name: Notify Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: '✅ Production deployment successful!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: '❌ Production deployment failed! @here'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================================================
  # Post-Deployment Jobs
  # ============================================================================

  performance-testing:
    name: Performance Testing
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Load Tests
        run: |
          pip install locust
          locust -f healthcare-pipeline/tests/load_test.py \
            --host=https://staging.healthcare-pipeline.example.com \
            --users=100 \
            --spawn-rate=10 \
            --run-time=5m \
            --headless

  security-posture-check:
    name: Security Posture Assessment
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check AWS Security Hub findings
        run: |
          FINDINGS=$(aws securityhub get-findings \
            --filters '{"SeverityLabel":[{"Value":"CRITICAL","Comparison":"EQUALS"}]}' \
            --query 'Findings[].Id' --output text)

          if [ ! -z "$FINDINGS" ]; then
            echo "❌ Critical security findings detected!"
            exit 1
          fi

      - name: Check GuardDuty findings
        run: |
          FINDINGS=$(aws guardduty list-findings \
            --detector-id $(aws guardduty list-detectors --query 'DetectorIds[0]' --output text) \
            --finding-criteria '{"Criterion":{"severity":{"Gte":7}}}' \
            --query 'FindingIds' --output text)

          if [ ! -z "$FINDINGS" ]; then
            echo "❌ High severity GuardDuty findings detected!"
            exit 1
          fi
