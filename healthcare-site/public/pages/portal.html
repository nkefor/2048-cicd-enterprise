<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal | NP Healthcare Practice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<nav class="navbar">
    <a href="/" class="nav-brand">
        <svg viewBox="0 0 36 36" fill="none"><rect width="36" height="36" rx="8" fill="#0D6EFD"/><path d="M18 8v20M8 18h20" stroke="white" stroke-width="3" stroke-linecap="round"/></svg>
        NP Healthcare
    </a>
    <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/services">Services</a></li>
        <li><a href="/telehealth">Telehealth</a></li>
        <li><a href="/dot-physicals">DOT Physicals</a></li>
        <li><a href="/contact">Contact</a></li>
    </ul>
    <div class="nav-actions"></div>
    <button class="mobile-menu-btn" onclick="document.querySelector('.nav-links').classList.toggle('open')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
</nav>

<div class="page-wrapper">
    <!-- Auth Forms (shown when not logged in) -->
    <div id="auth-section">
        <div class="page-header">
            <h1>Patient Portal</h1>
            <p>Sign in to manage your appointments, payments, and health records</p>
        </div>
        <div class="page-content" style="max-width:500px">
            <div id="auth-alerts"></div>
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" data-tab="login-tab">Sign In</button>
                    <button class="tab" data-tab="register-tab">Create Account</button>
                </div>

                <!-- Login Form -->
                <div class="tab-content active" id="login-tab">
                    <form onsubmit="loginPatient(event)">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" class="form-control" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" class="form-control" required placeholder="Your password">
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg" style="width:100%">Sign In</button>
                    </form>
                </div>

                <!-- Register Form -->
                <div class="tab-content" id="register-tab">
                    <form onsubmit="registerPatient(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reg-first">First Name *</label>
                                <input type="text" id="reg-first" class="form-control" required placeholder="First name">
                            </div>
                            <div class="form-group">
                                <label for="reg-last">Last Name *</label>
                                <input type="text" id="reg-last" class="form-control" required placeholder="Last name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reg-email">Email *</label>
                            <input type="email" id="reg-email" class="form-control" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="reg-phone">Phone</label>
                            <input type="tel" id="reg-phone" class="form-control" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="reg-dob">Date of Birth</label>
                            <input type="date" id="reg-dob" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="reg-password">Password *</label>
                            <input type="password" id="reg-password" class="form-control" required minlength="8" placeholder="Minimum 8 characters">
                        </div>
                        <div class="form-group">
                            <label for="reg-confirm">Confirm Password *</label>
                            <input type="password" id="reg-confirm" class="form-control" required placeholder="Confirm password">
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg" style="width:100%">Create Account</button>
                    </form>
                </div>
            </div>

            <div style="text-align:center;margin-top:2rem">
                <a href="/admin" style="color:var(--gray);font-size:0.9rem">Provider Login</a>
            </div>
        </div>
    </div>

    <!-- Portal Dashboard (shown when logged in) -->
    <div id="portal-section" style="display:none">
        <div class="page-header" style="padding:2rem">
            <h1 id="welcome-msg">Welcome</h1>
            <p>Manage your appointments, payments, and health information</p>
        </div>

        <div class="portal-layout">
            <div class="portal-sidebar">
                <div style="text-align:center;margin-bottom:1.5rem">
                    <div id="patient-avatar" style="width:60px;height:60px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:700;margin:0 auto 0.75rem"></div>
                    <strong id="patient-name"></strong>
                </div>
                <ul class="portal-sidebar-nav">
                    <li><a href="#" class="active" onclick="showPortalTab('dashboard')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                        Dashboard
                    </a></li>
                    <li><a href="#" onclick="showPortalTab('appointments')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Appointments
                    </a></li>
                    <li><a href="#" onclick="showPortalTab('payments')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                        Payments
                    </a></li>
                    <li><a href="#" onclick="showPortalTab('messages')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        Messages
                    </a></li>
                    <li><a href="#" onclick="showPortalTab('profile')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Profile
                    </a></li>
                    <li><a href="#" onclick="Auth.logout()" style="color:var(--danger)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Sign Out
                    </a></li>
                </ul>
            </div>

            <div class="portal-main">
                <div id="portal-alerts"></div>

                <!-- Dashboard Tab -->
                <div class="portal-tab active" id="tab-dashboard">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                        <h2 style="font-size:1.5rem">Dashboard</h2>
                        <a href="/book" class="btn btn-primary btn-sm">Book New Appointment</a>
                    </div>
                    <div class="card" style="margin-bottom:1.5rem">
                        <div class="card-header">Upcoming Appointments</div>
                        <div class="card-body" id="upcoming-appts">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Recent Payments</div>
                        <div class="card-body" id="recent-payments">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Appointments Tab -->
                <div class="portal-tab" id="tab-appointments" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                        <h2 style="font-size:1.5rem">My Appointments</h2>
                        <a href="/book" class="btn btn-primary btn-sm">Book New</a>
                    </div>
                    <div class="card">
                        <div class="card-body" id="all-appointments">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div class="portal-tab" id="tab-payments" style="display:none">
                    <h2 style="font-size:1.5rem;margin-bottom:1.5rem">Payment History</h2>
                    <div class="card">
                        <div class="card-body" id="payment-history">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div class="portal-tab" id="tab-messages" style="display:none">
                    <h2 style="font-size:1.5rem;margin-bottom:1.5rem">Messages</h2>
                    <div class="card" style="margin-bottom:1.5rem">
                        <div class="card-header">Send a Message</div>
                        <div class="card-body">
                            <form onsubmit="sendMessage(event)">
                                <div class="form-group">
                                    <label for="msg-subject">Subject</label>
                                    <input type="text" id="msg-subject" class="form-control" placeholder="Subject">
                                </div>
                                <div class="form-group">
                                    <label for="msg-body">Message</label>
                                    <textarea id="msg-body" class="form-control" required placeholder="Type your message..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Send Message</button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Message History</div>
                        <div class="card-body" id="message-list">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="portal-tab" id="tab-profile" style="display:none">
                    <h2 style="font-size:1.5rem;margin-bottom:1.5rem">My Profile</h2>
                    <div class="card">
                        <div class="card-body">
                            <form onsubmit="updateProfile(event)" id="profile-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Phone</label>
                                        <input type="tel" id="prof-phone" class="form-control" placeholder="(555) 123-4567">
                                    </div>
                                    <div class="form-group">
                                        <label>Gender</label>
                                        <select id="prof-gender" class="form-control">
                                            <option value="">Select</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" id="prof-address" class="form-control" placeholder="Street address">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>City</label>
                                        <input type="text" id="prof-city" class="form-control" placeholder="City">
                                    </div>
                                    <div class="form-group">
                                        <label>State</label>
                                        <input type="text" id="prof-state" class="form-control" placeholder="State">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ZIP Code</label>
                                        <input type="text" id="prof-zip" class="form-control" placeholder="12345">
                                    </div>
                                    <div class="form-group">
                                        <label>Insurance Provider</label>
                                        <input type="text" id="prof-insurance" class="form-control" placeholder="Insurance company">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Insurance ID</label>
                                        <input type="text" id="prof-insurance-id" class="form-control" placeholder="Member ID">
                                    </div>
                                    <div class="form-group">
                                        <label>Emergency Contact</label>
                                        <input type="text" id="prof-emergency-name" class="form-control" placeholder="Contact name">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Phone</label>
                                    <input type="tel" id="prof-emergency-phone" class="form-control" placeholder="(555) 123-4567">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-bottom" style="border-top:none;padding-top:0">
        <span>&copy; 2025 NP Healthcare Practice. All rights reserved.</span>
        <span>HIPAA Compliant | Secure & Encrypted</span>
    </div>
</footer>

<script src="/js/main.js"></script>
<script>
const serviceNames = {
    telehealth: 'Telehealth', dot_physical: 'DOT Physical',
    consultation: 'Consultation', follow_up: 'Follow-Up'
};

document.addEventListener('DOMContentLoaded', () => {
    if (window.location.hash === '#register') {
        document.querySelector('[data-tab="register-tab"]').click();
    }

    if (Auth.isLoggedIn()) {
        showPortal();
    }
});

async function loginPatient(e) {
    e.preventDefault();
    try {
        const data = await api('/api/auth/login', {
            method: 'POST',
            body: JSON.stringify({
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value
            })
        });
        Auth.setPatient(data.token, data.patient);
        showPortal();
    } catch (err) {
        showAlert(document.getElementById('auth-alerts'), err.message, 'error');
    }
}

async function registerPatient(e) {
    e.preventDefault();
    const password = document.getElementById('reg-password').value;
    const confirm = document.getElementById('reg-confirm').value;

    if (password !== confirm) {
        showAlert(document.getElementById('auth-alerts'), 'Passwords do not match', 'error');
        return;
    }

    try {
        const data = await api('/api/auth/register', {
            method: 'POST',
            body: JSON.stringify({
                first_name: document.getElementById('reg-first').value,
                last_name: document.getElementById('reg-last').value,
                email: document.getElementById('reg-email').value,
                password,
                phone: document.getElementById('reg-phone').value,
                date_of_birth: document.getElementById('reg-dob').value
            })
        });
        Auth.setPatient(data.token, data.patient);
        showPortal();
    } catch (err) {
        showAlert(document.getElementById('auth-alerts'), err.message, 'error');
    }
}

function showPortal() {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('portal-section').style.display = 'block';
    updateNav();

    const patient = Auth.getPatient();
    if (patient) {
        document.getElementById('welcome-msg').textContent = `Welcome, ${patient.first_name}`;
        document.getElementById('patient-name').textContent = `${patient.first_name} ${patient.last_name}`;
        document.getElementById('patient-avatar').textContent = `${patient.first_name[0]}${patient.last_name[0]}`;
    }

    loadDashboard();
}

function showPortalTab(tab) {
    document.querySelectorAll('.portal-tab').forEach(t => t.style.display = 'none');
    document.getElementById(`tab-${tab}`).style.display = 'block';
    document.querySelectorAll('.portal-sidebar-nav a').forEach(a => a.classList.remove('active'));
    event.target.closest('a').classList.add('active');

    if (tab === 'dashboard') loadDashboard();
    if (tab === 'appointments') loadAppointments();
    if (tab === 'payments') loadPaymentHistory();
    if (tab === 'messages') loadMessages();
    if (tab === 'profile') loadProfile();
}

async function loadDashboard() {
    try {
        const [appts, payments] = await Promise.all([
            api('/api/appointments/my'),
            api('/api/payments/history')
        ]);

        const upcoming = appts.filter(a => a.status !== 'cancelled' && a.status !== 'completed');
        const upcomingEl = document.getElementById('upcoming-appts');

        if (upcoming.length === 0) {
            upcomingEl.innerHTML = '<p style="color:var(--gray);text-align:center">No upcoming appointments. <a href="/book">Book one now</a>.</p>';
        } else {
            upcomingEl.innerHTML = upcoming.slice(0, 5).map(a => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid #E2E8F0">
                    <div>
                        <strong>${serviceNames[a.service_type] || a.service_type}</strong>
                        <div style="font-size:0.85rem;color:var(--gray)">${formatDate(a.appointment_date)} at ${formatTime(a.appointment_time)}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.75rem">
                        <span class="status status-${a.status}">${a.status}</span>
                        ${a.service_type === 'telehealth' && a.telehealth_link ? `<a href="${a.telehealth_link}" class="btn btn-primary btn-sm">Join</a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        const paymentsEl = document.getElementById('recent-payments');
        if (payments.length === 0) {
            paymentsEl.innerHTML = '<p style="color:var(--gray);text-align:center">No payment history.</p>';
        } else {
            paymentsEl.innerHTML = payments.slice(0, 5).map(p => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid #E2E8F0">
                    <div>
                        <strong>${p.description || 'Payment'}</strong>
                        <div style="font-size:0.85rem;color:var(--gray)">${new Date(p.created_at).toLocaleDateString()}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.75rem">
                        <strong>${formatCurrency(p.amount)}</strong>
                        <span class="status status-${p.status}">${p.status}</span>
                    </div>
                </div>
            `).join('');
        }
    } catch (err) {
        console.error('Dashboard load error:', err);
    }
}

async function loadAppointments() {
    try {
        const appts = await api('/api/appointments/my');
        const el = document.getElementById('all-appointments');

        if (appts.length === 0) {
            el.innerHTML = '<p style="color:var(--gray);text-align:center">No appointments yet. <a href="/book">Book one now</a>.</p>';
            return;
        }

        el.innerHTML = `<div class="table-container"><table>
            <thead><tr><th>Service</th><th>Date</th><th>Time</th><th>Status</th><th></th></tr></thead>
            <tbody>${appts.map(a => `
                <tr>
                    <td>${serviceNames[a.service_type] || a.service_type}</td>
                    <td>${formatDate(a.appointment_date)}</td>
                    <td>${formatTime(a.appointment_time)}</td>
                    <td><span class="status status-${a.status}">${a.status}</span></td>
                    <td>
                        ${a.status === 'scheduled' ? `<button onclick="cancelAppt(${a.id})" class="btn btn-danger btn-sm">Cancel</button>` : ''}
                        ${a.service_type === 'telehealth' && a.telehealth_link && a.status !== 'cancelled' ? `<a href="${a.telehealth_link}" class="btn btn-primary btn-sm">Join</a>` : ''}
                    </td>
                </tr>
            `).join('')}</tbody>
        </table></div>`;
    } catch (err) {
        console.error('Appointments load error:', err);
    }
}

async function cancelAppt(id) {
    if (!confirm('Are you sure you want to cancel this appointment?')) return;
    try {
        await api(`/api/appointments/${id}/cancel`, { method: 'PATCH' });
        showAlert(document.getElementById('portal-alerts'), 'Appointment cancelled', 'success');
        loadAppointments();
    } catch (err) {
        showAlert(document.getElementById('portal-alerts'), err.message, 'error');
    }
}

async function loadPaymentHistory() {
    try {
        const payments = await api('/api/payments/history');
        const el = document.getElementById('payment-history');

        if (payments.length === 0) {
            el.innerHTML = '<p style="color:var(--gray);text-align:center">No payment history.</p>';
            return;
        }

        el.innerHTML = `<div class="table-container"><table>
            <thead><tr><th>Description</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody>${payments.map(p => `
                <tr>
                    <td>${p.description || 'Payment'}</td>
                    <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    <td><strong>${formatCurrency(p.amount)}</strong></td>
                    <td><span class="status status-${p.status}">${p.status}</span></td>
                </tr>
            `).join('')}</tbody>
        </table></div>`;
    } catch (err) {
        console.error('Payment history error:', err);
    }
}

async function loadMessages() {
    try {
        const messages = await api('/api/patients/messages');
        const el = document.getElementById('message-list');

        if (messages.length === 0) {
            el.innerHTML = '<p style="color:var(--gray);text-align:center">No messages yet.</p>';
            return;
        }

        el.innerHTML = messages.map(m => `
            <div style="padding:1rem;border-bottom:1px solid #E2E8F0;${m.sender_type === 'provider' ? 'background:var(--light)' : ''}">
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
                    <strong>${m.sender_type === 'patient' ? 'You' : 'Provider'}: ${m.subject || 'No Subject'}</strong>
                    <span style="font-size:0.85rem;color:var(--gray)">${new Date(m.created_at).toLocaleString()}</span>
                </div>
                <p style="color:var(--gray);font-size:0.95rem">${m.body}</p>
            </div>
        `).join('');
    } catch (err) {
        console.error('Messages error:', err);
    }
}

async function sendMessage(e) {
    e.preventDefault();
    try {
        await api('/api/patients/messages', {
            method: 'POST',
            body: JSON.stringify({
                subject: document.getElementById('msg-subject').value,
                body: document.getElementById('msg-body').value
            })
        });
        document.getElementById('msg-subject').value = '';
        document.getElementById('msg-body').value = '';
        showAlert(document.getElementById('portal-alerts'), 'Message sent', 'success');
        loadMessages();
    } catch (err) {
        showAlert(document.getElementById('portal-alerts'), err.message, 'error');
    }
}

async function loadProfile() {
    try {
        const p = await api('/api/auth/me');
        document.getElementById('prof-phone').value = p.phone || '';
        document.getElementById('prof-gender').value = p.gender || '';
        document.getElementById('prof-address').value = p.address || '';
        document.getElementById('prof-city').value = p.city || '';
        document.getElementById('prof-state').value = p.state || '';
        document.getElementById('prof-zip').value = p.zip_code || '';
        document.getElementById('prof-insurance').value = p.insurance_provider || '';
        document.getElementById('prof-insurance-id').value = p.insurance_id || '';
    } catch (err) {
        console.error('Profile load error:', err);
    }
}

async function updateProfile(e) {
    e.preventDefault();
    try {
        await api('/api/auth/me', {
            method: 'PUT',
            body: JSON.stringify({
                phone: document.getElementById('prof-phone').value,
                gender: document.getElementById('prof-gender').value,
                address: document.getElementById('prof-address').value,
                city: document.getElementById('prof-city').value,
                state: document.getElementById('prof-state').value,
                zip_code: document.getElementById('prof-zip').value,
                insurance_provider: document.getElementById('prof-insurance').value,
                insurance_id: document.getElementById('prof-insurance-id').value,
                emergency_contact_name: document.getElementById('prof-emergency-name').value,
                emergency_contact_phone: document.getElementById('prof-emergency-phone').value
            })
        });
        showAlert(document.getElementById('portal-alerts'), 'Profile updated successfully', 'success');
    } catch (err) {
        showAlert(document.getElementById('portal-alerts'), err.message, 'error');
    }
}
</script>
</body>
</html>
