---
- name: Deploy Application
  hosts: tier_Private
  become: yes
  vars:
    app_name: "3tier-app"
    app_version: "{{ lookup('env', 'APP_VERSION') | default('latest', true) }}"
    app_port: 80
    health_check_url: "http://localhost/health"

  pre_tasks:
    - name: Ensure application directory exists
      file:
        path: /var/www/html
        state: directory
        owner: apache
        group: apache
        mode: '0755'

  tasks:
    - name: Stop application service
      systemd:
        name: httpd
        state: stopped
      ignore_errors: yes

    - name: Backup current application
      archive:
        path: /var/www/html
        dest: "/tmp/app_backup_{{ ansible_date_time.epoch }}.tar.gz"
      when: ansible_local.app.version is defined

    - name: Deploy application files
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: apache
        group: apache
        mode: '0644'
      loop:
        - { src: 'app/index.html.j2', dest: '/var/www/html/index.html' }
        - { src: 'app/health.j2', dest: '/var/www/html/health' }
      notify: restart httpd

    - name: Create application metadata
      copy:
        content: |
          {
            "version": "{{ app_version }}",
            "deployed_at": "{{ ansible_date_time.iso8601 }}",
            "deployed_by": "{{ ansible_user_id }}"
          }
        dest: /etc/ansible/facts.d/app.fact
        mode: '0644'

    - name: Start application service
      systemd:
        name: httpd
        state: started
        enabled: yes

    - name: Wait for application to start
      wait_for:
        port: "{{ app_port }}"
        delay: 5
        timeout: 60

    - name: Health check
      uri:
        url: "{{ health_check_url }}"
        status_code: 200
        return_content: yes
      register: health_check
      until: health_check.status == 200
      retries: 5
      delay: 10

    - name: Display deployment status
      debug:
        msg:
          - "Application deployed successfully"
          - "Version: {{ app_version }}"
          - "Health check: {{ health_check.status }}"

  handlers:
    - name: restart httpd
      systemd:
        name: httpd
        state: restarted
