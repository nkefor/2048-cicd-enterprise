apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-providers
  namespace: monitoring
data:
  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: default
        orgId: 1
        folder: ''
        type: file
        disableDeletion: true
        editable: false
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
data:
  game-2048-overview.json: |
    {
      "dashboard": {
        "title": "Game 2048 - Overview",
        "uid": "game-2048-overview",
        "timezone": "browser",
        "refresh": "30s",
        "time": { "from": "now-1h", "to": "now" },
        "panels": [
          {
            "title": "Request Rate (req/s)",
            "type": "timeseries",
            "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
            "targets": [{
              "expr": "sum(rate(nginx_http_requests_total[5m]))",
              "legendFormat": "Total Requests/s"
            }]
          },
          {
            "title": "Error Rate (%)",
            "type": "timeseries",
            "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
            "targets": [{
              "expr": "sum(rate(nginx_http_requests_total{status=~\"5..\"}[5m])) / sum(rate(nginx_http_requests_total[5m])) * 100",
              "legendFormat": "5xx Error Rate %"
            }],
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "yellow", "value": 1 },
                    { "color": "red", "value": 5 }
                  ]
                }
              }
            }
          },
          {
            "title": "P95 Latency (seconds)",
            "type": "timeseries",
            "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
            "targets": [{
              "expr": "histogram_quantile(0.95, sum(rate(nginx_http_request_duration_seconds_bucket[5m])) by (le))",
              "legendFormat": "P95 Latency"
            }]
          },
          {
            "title": "Active Pods",
            "type": "stat",
            "gridPos": { "h": 8, "w": 6, "x": 12, "y": 8 },
            "targets": [{
              "expr": "count(kube_pod_status_ready{namespace=\"game-2048\", condition=\"true\"})",
              "legendFormat": "Ready Pods"
            }]
          },
          {
            "title": "CPU Usage (%)",
            "type": "gauge",
            "gridPos": { "h": 8, "w": 6, "x": 18, "y": 8 },
            "targets": [{
              "expr": "avg(rate(container_cpu_usage_seconds_total{namespace=\"game-2048\"}[5m])) * 100",
              "legendFormat": "CPU %"
            }],
            "fieldConfig": {
              "defaults": {
                "max": 100,
                "thresholds": {
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "yellow", "value": 60 },
                    { "color": "red", "value": 80 }
                  ]
                }
              }
            }
          },
          {
            "title": "Memory Usage (MB)",
            "type": "timeseries",
            "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
            "targets": [{
              "expr": "sum(container_memory_usage_bytes{namespace=\"game-2048\"}) / 1024 / 1024",
              "legendFormat": "Memory MB"
            }]
          },
          {
            "title": "Pod Restarts",
            "type": "stat",
            "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
            "targets": [{
              "expr": "sum(kube_pod_container_status_restarts_total{namespace=\"game-2048\"})",
              "legendFormat": "Total Restarts"
            }],
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "yellow", "value": 1 },
                    { "color": "red", "value": 5 }
                  ]
                }
              }
            }
          }
        ]
      }
    }
